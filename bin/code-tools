#!/usr/bin/env bash

set -euo pipefail

# Resolve project root
PROJECT_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || echo "$PWD")"

# Constants
if [ -d "$PROJECT_ROOT/services/vendor/kununu/code-tools" ]; then
  readonly CONFIG_DIR="$PROJECT_ROOT/services/vendor/kununu/code-tools"
  readonly VENDOR_DIR="$PROJECT_ROOT/services/vendor"
elif [ -d "$PROJECT_ROOT/vendor/kununu/code-tools" ]; then
  readonly CONFIG_DIR="$PROJECT_ROOT/vendor/kununu/code-tools"
  readonly VENDOR_DIR="$PROJECT_ROOT/vendor"
else
  echo "❌ Could not find 'vendor/kununu/code-tools'."
  exit 1
fi

readonly CONFIG_FILES=(
    "dist/php-cs-fixer.php.dist"
    "dist/phpcs.xml.dist"
    "dist/rector.php.dist"
)
readonly HOOK_FILE="Kununu/CS-Fixer/Hooks/git-pre-commit"
readonly HOOK_DEST="$PROJECT_ROOT/.git/hooks/pre-commit"

# Function to display help instructions
show_help() {
    cat <<EOF
Usage: vendor/bin/code-tools publish:config [tool-name] [--include-hook]

Valid tool names:
  coding-standards   => copies dist/php-cs-fixer.php.dist
  code-sniffer       => copies dist/phpcs.xml.dist
  rector             => copies dist/rector.php.dist

If no tool name is passed, all config files will be copied.

Options:
  --include-hook     Also copy the git pre-commit hook and symlink php-cs-fixer to .git/kununu/.
  --help             Show this help message.
EOF
}

# Function to copy a config file
copy_config_file() {
    local source_file="$CONFIG_DIR/$1"
    local dest_file="${1#dist/}"
    dest_file="${dest_file%.dist}"
    local dest_path="$PROJECT_ROOT/$dest_file"

    if [ -f "$dest_path" ]; then
        echo "⚠️  Config file '$dest_file' already exists at project level."
    elif [ -f "$source_file" ]; then
        cp "$source_file" "$dest_path"
        echo "✅ Config file '$dest_file' copied to project level."
    else
        echo "❌ Config file '$source_file' does not exist."
    fi
}

# Function to install the git pre-commit hook
install_git_hook() {
    local source_file="$CONFIG_DIR/$HOOK_FILE"
    local dest_file="$HOOK_DEST"

    if [ ! -d "$PROJECT_ROOT/.git/hooks" ]; then
        echo "❌ Error: .git/hooks directory does not exist. Is this a git repository?"
        exit 1
    fi

    if [ -f "$dest_file" ]; then
        echo "⚠️  A pre-commit hook already exists at $dest_file."
    elif [ -f "$source_file" ]; then
        cp "$source_file" "$dest_file"
        chmod +x "$dest_file"
        echo "✅ Git pre-commit hook installed to $dest_file."
    else
        echo "❌ Git hook file '$source_file' does not exist."
    fi
}

# Function to create symlinks inside .git/kununu/
create_symlink_in_git() {
    local origin="$1"
    local link_name="$2"

    local kununu_dir="$PROJECT_ROOT/.git/kununu"
    mkdir -p "$kununu_dir"

    local link_path="$kununu_dir/$link_name"

    if [ -L "$link_path" ] || [ -e "$link_path" ]; then
        echo "⚠️  Removing existing link or file: $link_path"
        rm -rf "$link_path"
    fi

    ln -s "$origin" "$link_path"
    echo "✅ Symlink created: $link_path -> $origin"
}

# Parse arguments
include_hook="false"

if [ "${1:-}" == "--help" ]; then
    show_help
    exit 0
fi

if [ "$#" -lt 1 ] || [ "$#" -gt 3 ]; then
    show_help
    exit 1
fi

if [ "$1" != "publish:config" ]; then
    echo "❌ Invalid command. Valid command: publish:config"
    exit 1
fi

tool_name=""
for arg in "$@"; do
    if [ "$arg" == "--include-hook" ]; then
        include_hook="true"
    elif [ "$arg" != "publish:config" ]; then
        tool_name="$arg"
    fi
done

# Handle config file copying
case "$tool_name" in
    "")
        for config_file in "${CONFIG_FILES[@]}"; do
            copy_config_file "$config_file"
        done
        ;;
    coding-standards)
        copy_config_file "dist/php-cs-fixer.php.dist"
        ;;
    code-sniffer)
        copy_config_file "dist/phpcs.xml.dist"
        ;;
    rector)
        copy_config_file "dist/rector.php.dist"
        ;;
    *)
        echo "❌ Invalid tool name: '$tool_name'"
        show_help
        exit 1
        ;;
esac

# Optionally install git hook and symlinks
if [ "$include_hook" == "true" ]; then
    install_git_hook

    # Create symlinks in .git/kununu/
    php_cs_fixer_config="$VENDOR_DIR/kununu/code-tools/dist/php-cs-fixer.php.dist"
    php_cs_fixer_bin="$VENDOR_DIR/bin/php-cs-fixer"

    create_symlink_in_git "$php_cs_fixer_config" ".php-cs-fixer.php"
    create_symlink_in_git "$php_cs_fixer_bin" "php-cs-fixer"
fi
